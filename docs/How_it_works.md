# Telegram Analyst 2 
(git: [BogdanSubm/telegram\_analyst2](https://github.com/BogdanSubm/telegram_analyst2))

(автор: git: [Va1erCa (Валерий Жидков)](https://github.com/Va1erCa)/  telegram: @Va1errCa)

# Резюме

Приложение предназначено для сбора статистики по интересующим TG-каналам.   
Кроме скачивания репозитория и настройки виртуального окружения (venv), для работы приложения потребуется учетная запись Telegram, для которой нужно зарегистрировать Telegram-приложение ([Creating your Telegram Application](https://core.telegram.org/api/obtaining_api_id)) и получить свои значения: api\_id и api\_hash. При первом запуске приложения (после внесения значения ключей в config.json) Telegram попросит авторизоваться с указанием телефонного номера и полученного в ответ цифрового кода (код приходит в папку “Личное” Telegram-клиента как сообщение от Telegram). После первой успешной авторизации создается файл сессии “telegram\_analyst2.session” в папке приложения. В дальнейшем, при повторных запусках приложения авторизация не запрашивается (при наличии файла сессии).

Управление приложением осуществляется в Telegram-клиенте (android, ios, windows и т.д.) открытом для учетной записи (в режиме юзер-бота), посредством набора команд: 

* **/instal**l \- сброс и создание заново всех таблиц базы данных;   
* **/start** \- запуск процессинга, в т.ч. поиск неучтенных в базе сообщений (постов) из всех каналов в мониторинге, создание расписания для задач обновления постов и т.д.;  
* **/restart** \- сброс текущего расписания задач, повторный поиск постов в каналах и создание нового расписания;  
* **/stat** \- вывод информации об общем количестве запланированных задач в текущем расписании в работе;  
* **/help** \- вывод краткой справки по командам;  
* **/stop** \- остановка процессинга, выход из приложения;  
* **/debug** (не описано в справке /help) \- вывод в консоль всех задач текущего расписания.

Находясь постоянно в работе приложение обеспечивает сбор основных метрик анализируемых каналов и их постов в режиме нон-стоп с учетом ключевых временных моментов “жизненного цикла” поста.

# Основные подходы

Приложение собирает статистику по TG-каналам, на которые подписан юзер-бот (используемый Telegram-аккаунт). Возможно применение фильтрации каналов.  
В работе приложения активно применяются два подхода: асинхронность и планирование (ведение расписания задач).  
Информация о новом посте в канале появляется в системе в результате запускаемой по расписанию задачи “Обновление постов”. Запускаемая несколько раз в сутки задача каждый раз сравнивает данные о постах учтенных в базе приложения и фактически присутствующих на момент запуска в Telegram, расхождения учитываются как в случае появления новых постов в Telegram, так и в случае отсутствия каких-то постов в Telegram из уже учтенных приложением (они помечаются как удаленные).  
На этом же принципе построена работа с каналами. Регулярно запускаемая задача “Обновление каналов” отслеживает актуальность каналов для юзер-бота и в случае подписки на новый канала, либо отписки от канала вносит изменения в свой план мониторинга каналов/постов.  
Далее, на основе собранной информации о новых постах создается расписание для запуска типовых задач обновления информации о посте (замере метрик) в интересующие ключевые моменты “жизни” поста. Так, в примере файла настроек приведен график замера метрик: после 1х суток, 2х, 3х, 7х, 14х. Данные интервалы отмеряются от времени создания каждого поста, обеспечивая, таким образом, точность и корректность фиксируемых для него метрик.   
Метрики каналов, при этом, обновляются по отдельному графику \- раз в сутки в 23:50.

***Прим.:** Все параметры даты/времени используются без учета часовых поясов.*

# Сценарий использования

## Начальный запуск (инициализация)

***Прим.: д**оступно если в папке приложения отсутствует файл статуса приложения \- “.app\_status” или он есть и содержит статусы: “not running” \- “инициализация не производилась” или “first run” \- “процессинг не запускался”.*	

### Команда в юзер-боте \- “/install” 

1. приложение пересоздает все таблицы базы данных  
2. в файле статуса приложения устанавливается статус “first run”

   

***Прим.:** если необходимо принудительно пересоздать все таблицы заново,  перед вызовом команды “/install” следует удалить  файл статуса приложения из папки приложения.*

## Запуск процессинга

***Прим.: д**оступно после начального запуска (инициализации) \- файл статуса содержит статус \- “first run” или как очередной запуск \- в файле статуса статус \- “stopped” .*

### Команда в юзер-боте \- “/start” 

1. запуск задачи “обновление каналов” (при первом запуске \- создание списка каналов, при последующих \- проверка выполнения ранее запланированных обновлений)  
2. запуск задачи “обновление постов” \-\> “обновление задач”  
3. запуск задачи “создание расписания” \- создается расписание, включающее:  
   1. ежедневный запуск задачи “обновление каналов” в 23:50  
   2. запуск задачи “обновление постов” регулярно по заданному графику (например, 5 раз в сутки в: 00:05, 08:05, 12:05, 16:05, 20:05)  
   3. все неисполненные типовые задачи \- “обновление поста”, сохраненные в  хранилище задач (таблица \<task\_plan\>)  
4. переход в режим ожидания/исполнения задач \- процессинг, в файле статуса приложения устанавливается статус “processing”

## Рестарт

***Прим.: д**оступно в режиме процессинга \- файл статуса содержит статус \- “processing”.*

### Команда в юзер-боте \- “/restart” 

1. завершение исполняющихся задач, остановка работающего расписания задач и его сброс  
2. запуск задачи “обновление постов” \-\> “обновление задач”  
3. запуск задачи “создание расписания” (аналогично пункту 3 раздела “Запуск процессинга”)  
4. переход в режим ожидания/исполнения задач \- процессинг

## Выход

### Команда в юзер-боте \- “/stop” 

1. завершение исполняющихся задач, остановка расписания задач  
2. в файле статуса приложения устанавливается статус “stopped”, выход из приложения

## Дополнительные возможности

### Команда в юзер-боте \- “/help” \-

вывод в юзер-бот сообщения с перечнем доступных команд приложения

### Команда в юзер-боте \- “/stat” \-

вывод в юзер-бот текущего количества задач в расписании и объема используемой приложением оперативной памяти

### Команда в юзер-боте \- “/debug” \-

вывод в консоль списка всех задач в расписании, вывод в юзер-бот сообщения об объеме используемой приложением оперативной памяти

# Реализация



## База данных

### Схема базы данных приложения :


### Описание базы данных приложения (таблицы) :

| № п/п | поле | тип | пояснение |
| ----- | ----- | ----- | ----- |
| channel (канал) |  |  |  |
| 1 | id | INT8 (primary key) | ид канала (как в Telegram) |
| 2 | username  | VARCHAR | название канала  (как в Telegram)  |
| 3 | title | VARCHAR | заголовок канала  (как в Telegram) |
| 4 | category | VARCHAR | тематика канала (по умолчанию \- DA) |
| 5 | creation\_time | TIMESTAMP | дата создания канала |
| 6 | turn\_on\_time | TIMESTAMP | время постановки канала на анализ |
| 7 | turn\_off\_time | TIMESTAMP | время снятия канала с анализа |
| channel\_hist (история канала) |  |  |  |
| 1 | channel\_id  | INT8 (foreign key) | ид канала |
| 5 | update\_time | TIMESTAMP | время обновления |
| 6 | subscribers | INT4 | текущее количество подписчиков |
| 7 | msg\_count  | INT4 | общее количество сообщений (данные Telegram, включая все фреймы медиа-групп и все сервисные сообщения) |
| post (пост) |  |  |  |
| 1 | channel\_id  | INT8 (PK.1) | ид канала (часть группового PK) |
| 2 | post\_id  | INT4 (PK.2) | ид поста (часть группового PK) |
| 3 | forward\_from\_chat | INT8  | ид канала откуда переслан пост |
| 4 | creation\_time  | TIMESTAMP | время создания поста в Telegram |
| 5 | drop\_time  | TIMESTAMP | время удаления поста из Telegram (время выполнения задачи обновления поста когда пост уже отсутствует в Tg) |
| 6 | is\_advertising | BOOLEAN | признак рекламного поста |
| 7 | media\_group\_id | INT8 (UNIQUE) | ид медиа-группы (может отсутствовать) |
| 8 | media\_type | VARCHAR | тип медиа контента поста (одно из значений словаря \<media\_types\_encoder\> из модуля \<app\_types.py\>) |
| 9 | post\_text  | VARCHAR | текст/подпись поста (часть исходного текстового поля поста) |
| 10 | text\_len  | INT4 | длина текста/подписи поста |
| 11 | text\_entities\_count  | INT4 | сложность текста/подписи поста (количество сущностей форматирования используемых в посте) |
| 12 | post\_url | VARCHAR | url-ссылка на пост |
| 13 | is\_planned | BOOLEAN | запланированы ли задачи обновления для поста |
| post\_hist (история поста)  |  |  |  |
| 1 | channel\_id  | INT8 (FK.1) | ид канала (часть группового FK) |
| 2 | post\_id  | INT4 (FK.2) | ид поста (часть группового FK) |
| 3 | update\_time | TIMESTAMP | время обновления |
| 4 | observation\_day | INT4 | номер дня наблюдения |
| 5 | post\_comments | INT4 | число комментариев	 |
| 6 | post\_views | INT4 | число просмотров |
| 7 | stars | INT4 | число звезд |
| 8 | positives | INT4 | число позитивных реакций |
| 9 | negatives | INT4 | число негативных  реакций |
| 10 | neutrals | INT4 | число нейтральных  реакций |
| 11 | customs | INT4 | число кастом реакций (пользовательские эмодзи) |
| 12 | reposts | INT4 | число репостов |
| media\_group (медиа-группа) |  |  |  |
| 1 | media\_group\_id | INT8 (FK from post) | ид медиа-группы |
| 2 | update\_time | TIMESTAMP | время обновления |
| 3 | post\_id  | INT4 | ид поста (фрейма медиа-группы) |
| 4 | observation\_day | INT4 | номер дня наблюдения |
| 5 | post\_order  | INT2  | номер фрейма в медиагруппе  |
| 6 | post\_views | INT4 | число просмотров фрейма |
| 7 | reposts  | INT4 | число репостов фрейма |
| task\_plan (база заданий \- служебная таблица) |  |  |  |
| 1 | channel\_id  | INT8 (FK.1) | ид канала (часть группового FK) |
| 2 | post\_id  | INT4 (FK.2) | ид поста (часть группового FK) |
| 3 | observation\_day | INT4 | номер дня наблюдения |
| 4 | planned\_at  | TIMESTAMP | запланированное время запуска задачи |
| 5 | completed\_at  | TIMESTAMP | время фактического завершения задачи |
| channel\_plan (план обновления истории каналов \- служебная таблица) |  |  |  |
| 1 | planned\_at  | TIMESTAMP | запланированное время запуска задачи |
| 2 | completed\_at  | TIMESTAMP | время фактического завершения задачи |

## Конфигурирование (config.json) 

| ключ | значение  | тип | пояснение |
| ----- | :---: | ----- | ----- |
| **telegram \- параметры Telegram** |  |  |  |
| api\_id | your\_api | число | ваш api\_id |
| api\_hash | “\_\_your\_hash\_\_” | строка | ваш api\_hash |
| api\_calls\_per\_minute | 140 | число | ограничение по частоте обращения к функциям api Telegram для избежания срабатывания Telegram-защиты от флуда, применяется в классе Normalizer |
| api\_idle\_reset\_time | 300 | число | время в секундах \- через сколько сбросится адаптивные изменения параметра api\_calls\_per\_minute в классе Normalizer к стандартным значениям |
| **database\_connection \- параметры подключения к БД Postgres** |  |  |  |
| host | “localhost” | строка | сервер |
| port | 5432 | число | порт |
| dbname | "tg\_analyst2" | строка | имя БД |
| user | "postgres" | строка | имя пользователя БД |
| password | "123456" | строка | пароль пользователя БД |
| **logging \- параметры системы логирования** |  |  |  |
| level | “INFO” | строка | уровень логирования (один из ключей словаря \<logger\_level\> в модуле \<config\_py.py\> : “NOTSET”, “DEBUG”, “INFO”, “WARNING”, “ERROR”, “CRITICAL”) |
| to\_file | true | логич. | дублирование лога в файл |
| logs\_folder\_path | ".log" | строка | путь к папке хранения лог-файлов |
| file\_name\_prefix | "tg\_an2\_" | строка | префикс в имени лог-файла (имя файла вида: \<префикс\>\<YYYY-MM-DD\>\_\<HH-MM\>) |
| max\_num\_log\_files | 30 | число | максимальная емкость папки хранения лог-файлов |
| **pyrogram \- параметры библиотеки для работы с api Telegram (kurigram)** |  |  |  |
| plugins | \- | словарь | словарь для организации работы с обработчиками событий  |
| plugins.root | "plugins" | строка | имя папки для хранения python-файлов с обработчиками  |
| plugins.include | \["handlers"\] | список строк | список с именами подключаемых python-файлов с обработчиками  |
| plugins.exclude | \[ \] | список строк | список с именами отключаемыми python-файлами с обработчиками  |
| **analyst \- общие параметры приложения** |  |  |  |
| analyzing\_from | "2025-01-01 00:00:00.000" | строка | время начала анализируемого периода (возможно указание даты ранее даты фактического развертывания приложения) |
| numb\_channels\_process | 500 | число | максимальное число каналов для анализа (500 \- стандартное максимальное число подписок юзер-бота в Telegram, параметр \- не используется) |
| size\_text\_fragment\_for\_save | 128 | число | размер фрагмента текстового поля поста сохраняемый в БД |
| chunk\_size\_for\_db\_ops | 1000 | число | максимальное число записей записываемых в БД в одном запросе INSERT |
| chunk\_size\_for\_tg\_ops | 100 | число | максимальное число объектов Telegram получаемых в потоке до генерации анти-флуд паузы |
| media\_group\_post\_ordering\_base | 1 | число | база для начала нумерации фреймов медиа-поста |
| channel\_selection\_filter | \[ \] | список чисел | фильтр каналов (список ИД каналов, которые будут анализироваться из числа всех подписок юзер-бота, если пуст \- анализируются все каналы) |
| **schedules \- параметры расписаний** |  |  |  |
| update\_log\_file | \- | словарь | параметры расписания создания нового лог-файла \- время одной ежесуточной операции  |
| update\_log\_file.hour | 0 | число (0-23) | час  |
| update\_log\_file.minute | 0 | число (0-59) | минута |
| update\_log\_file.second | 0 | число (0-59) | секунда |
| update\_channels | \- | словарь | параметры расписания запуска задачи “обновление каналов” \- время одной ежесуточной операции  |
| update\_channels.hour | 0 | число (0-23) | час  |
| update\_channels.minute | 0 | число (0-59) | минута |
| update\_channels.second | 0 | число (0-59) | секунда |
| update\_posts | \- | словарь | параметры расписания запуска задачи “обновление постов” \- график нескольких запусков (количество  не ограничено, все списки должны быть одинакового размера)  |
| update\_posts.hour | \[0, 8, 12, 16, 20\] | список чисел (0-23) | часы  |
| update\_posts.minute | \[5, 5, 5, 5, 5\] | список чисел (0-59) | минуты |
| update\_posts.second | \[0, 0, 0, 0, 0\] | список чисел (0-59) | секунды |
| post\_observation\_days | \[1, 2, 3, 7, 14\] | список чисел (1-...) | список номеров суток с момента создания поста в канале, сразу по истечении которых делается замер метрик поста(медиа-группы) |
| min\_duration\_observation\_task | 1.2 | число | максимальное время в секундах отводимое на одну задачу замера метрик поста (с учетом работающего анти-флуд механизма) |

# Некоторые пояснения

1. Приложение позволяет начать анализ с любой пропущенной даты (например с 1 января 2025 года). В этом случае, для постов, которые были созданы до даты постановки каналов на анализ (даты запуска процессинга) метрики фиксируются в те дни (из списка \<post\_observation\_days\> файла настроек),  которые еще не вышли за пределы текущей даты, если все дни графика пропущены метрики фиксируются один раз за текущий день обработки с пометкой \<наблюдение последнего дня графика\> вне зависимости от фактического времени прошедшего с момента создания поста. В нашем случае \- это будет 14 день (через 14 суток от момента создания поста). Это сделано для сохранения всей номенклатуры постов для анализа.  
2. При этом, при выборе пропущенной даты для начала анализа (например с 1 января 2025 года) записей об истории каналов (количество подписчиков/сообщений) в пропущенных датах в таблице \<channel\_hist\> не будет. История каналов начинает фиксироваться с даты запуска процессинга.  
3. Предлагаемый график дней замера метрик \- список \<post\_observation\_days\> включает номера суток с момента создания поста: \[1, 2, 3, 7, 14\] в предположении, что для анализа постов канала нам будет интересна динамика метрик в первые три дня, через неделю и через две недели от момента создания поста. Далее, замер метрик не производится, в предположении об их практической неизменности на больших временных горизонтах.  
4. Особенностью организации хранения информации о сообщениях (постах) в Telegram является то что для постов (медиа-групп), включающих наборы (картинок, видео и т.д.) все составляющие такого набора (фреймы)  в TG хранятся как отдельные сообщения, соответственно, применяется их сквозная нумерация. Обращения к штатной api-функции Telegram для определения количества сообщений в канале возвращает количество ВСЕХ сообщений (сервисных сообщений, постов без фреймов, всех фреймов медиа-групп), что не совсем корректно для нашего анализа. Данное значение справочно фиксируется в таблице \<channel\_hist\> в поле \<msg\_count\>. Для получения корректного значения количества постов на определенный момент времени, пользователю БД необходимо будет воспользоваться соответствующим  SQL-запросом к нашей БД.   
5. Для обеспечения высокой надежности приложения с целью выполнения бесперебойного мониторинга и обеспечения целостности данных в приложении предусмотрен ряд мер:  
   1. обновление истории канала: если по каким-то причинам произошел сбой добавления ежесуточной истории канала (таблица \<channel\_hist\>), при первом последующем запуске/перезапуске приложения, либо запуске задачи “обновление постов” по расписанию, пропущенная задача обновления истории каналов будет запущена автоматически и история каналов за пропущенные сутки обновиться (данными на текущий момент времени).   
      *Прим.: Нужно учесть что, если до момента такого перезапуска (выполнения пропущенной задачи обновления истории каналов) юзер-бот отпишется от какого-либо канала в сегодняшней дате, то история по такому каналу в пропущенной дате будет отсутствовать (таблица \<channel\_hist\>).*   
   2. обновление постов: если по каким-то причинам произошел сбой приложения, при первом последующем запуске/перезапуске приложения, производится повторный мониторинг Telegram на наличие изменений актуального списка постов в каналах (таблица \<post\>), все неисполненные задачи замера метрик (по данным базы заданий \- таблица \<task\_plan\>) с наступившими сроками запуска исполняются немедленно с фиксацией текущих значений метрик (таблица \<post\_hist\> и \<media\_group\>). Далее формируется расписание задач и приложение продолжает работу в режиме процессинга.  
6. В случае изменения настроек (файл \<config.json\>) изменения начнут действовать после перезапуска приложения (завершение \- команда /stop в Telegram и потом запуск и команда /start в Telegram, но НЕ /restart).  
7. В качестве “обратной связи” для информирования о своем нормальном функционировании, приложение регулярно, согласно графика запуска задачи ”обновление постов” (параметр \<update\_posts\> файла конфигурации) присылает в Telergam (чат “Избранное” папки “Личное”) сообщение: “I’m online…” (и данные о количестве задач и объеме используемой оперативной памяти). 
